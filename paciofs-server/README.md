# paciofs-server
The entry point is [PacioFS.java](./src/main/java/de/zib/paciofs/PacioFs.java).
- Load [application.conf](./src/main/resources/application.conf).
- Set up logging from [logback.xml](./src/main/resources/logback.xml).
- Start actor system and discovery, depending on whether this is a kubernetes environment or not. See [paciofs-kubernetes](../paciofs-kubernetes/README.md) for kubernetes deployment, [test.sh](../.travis/test.sh) for local execution, and [README](../README.md) for `minikube` execution.
- Start the MultiChain client. This starts a MultiChain locally and waits for enough UTXOs to be available. This is necessary because during mining, a single UTXO is generated, which we split into smaller pieces. This way we do not have to wait for the change from a previous transaction, but instead can use many different UTXOs in rapid succession for lower latency.
- Set up the services listening for requests from the [client utilities](../paciofs-client/README.md).

## [MultiChainClientFactory](./src/main/java/de/zib/paciofs/multichain/MultiChainClientFactory.java)
Creates a client that before each RPC request tests whether MultiChain is running.
If it is not, then [MultiChainDaemon](./src/main/java/de/zib/paciofs/multichain/MultiChainDaemon.java) is started locally if desired.
Remote chains have not been tested so far, as we only use one node with one local MultiChain instance.

A [MultiChainJsonRpcClient](./src/main/java/de/zib/paciofs/multichain/rpc/MultiChainJsonRpcClient.java) is created that communicates with MultiChain via RPC calls.
Authorization is handled as well as serialization and parsing of messages.
The authorization information is obtained within the client factory which reads a configuration file generated by MultiChain during startup.

## [MultiChainUtil](./src/main/java/de/zib/paciofs/multichain/MultiChainUtil.java)
Takes a MultiChain client instance and adds functions for sending and receiving transactions.
This means serialization and parsing of messages to and from `OP_RETURN` outputs.
This is used by [MultiChainCluster](./src/main/java/de/zib/paciofs/multichain/abstractions/MultiChainCluster.java) and [MultiChainFileSystem](./src/main/java/de/zib/paciofs/multichain/abstractions/MultiChainFileSystem.java) to store data on the blockchain as well as read from it.

## [MultiChainActor](./src/main/java/de/zib/paciofs/multichain/actors/MultiChainActor.java)
This actor queries the MultiChain instance regularly for new transactions and relays them to all registered consumers.
Currently this is the MultiChainCluster and MultiChainFileSystem (see above).
Also, the actor makes sure that enough UTXOs are available by splitting the available ones in half until a specified threshold has been reached.

## Services
The [PacioFsServiceImpl](./src/main/java/de/zib/paciofs/grpc/PacioFsServiceImpl.java) implements the creation of file systems, triggered by the `mkfs.paciofs` client utility.

The [PosixIoServiceImpl](./src/main/java/de/zib/paciofs/io/posix/grpc/PosixIoServiceImpl.java) implements the relevant file system operations, triggered by the `mount.paciofs` client utility.
All data is saved locally (no distribution of data at the moment).

Both use the MultiChainFileSystem abstraction for storing data on the blockchain.
